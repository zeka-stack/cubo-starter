# ğŸŒŸ Spring Boot é…ç½®çƒ­æ›´æ–°æ¡†æ¶ï¼ˆé Spring Cloud ç¯å¢ƒï¼‰

## **ğŸ“Œ é¡¹ç›®ç›®æ ‡**

åœ¨ä¸å¼•å…¥ Spring Cloud çš„å‰æä¸‹ï¼Œå®ç°ç±»ä¼¼ @RefreshScope çš„é…ç½®çƒ­æ›´æ–°æœºåˆ¶ï¼Œæ”¯æŒï¼š

- ä¿®æ”¹ application.yml æˆ– application-{profile}.yml åè‡ªåŠ¨ç”Ÿæ•ˆ
- æ— éœ€é‡å¯æœåŠ¡ï¼Œé…ç½®å®æ—¶åˆ·æ–°åˆ°é…ç½®ç±»
- æ”¯æŒæŒ‰é…ç½®ç±»åˆ·æ–°ï¼ˆéå…¨é‡åˆ·æ–°ï¼‰
- æ”¯æŒé…ç½®å˜æ›´å·®å¼‚æ¯”å¯¹ï¼ˆdiffï¼‰
- ä¸ Spring Cloud åŸç”Ÿ @RefreshScope å®Œå…¨å…¼å®¹

------

## **âœ… å®ç°åŠŸèƒ½**

| **åŠŸèƒ½ç‚¹**              | **æè¿°**                                                       |
|----------------------|--------------------------------------------------------------|
| ğŸ” å®æ—¶ç›‘å¬é…ç½®æ–‡ä»¶å˜æ›´        | æ”¯æŒ application.yml å’Œ profile æ–‡ä»¶ï¼ˆå¦‚ application-prod.ymlï¼‰çš„è‡ªåŠ¨ç›‘å¬ |
| ğŸ§  é…ç½®å˜æ›´å·®å¼‚åˆ†æ          | ç²¾ç¡®å¯¹æ¯”æ–°æ—§é…ç½®ï¼Œé¿å…æ— æ•ˆåˆ·æ–°                                              |
| ğŸ¯ ç²¾å‡†é…ç½®ç±»åˆ·æ–°           | ä»…åˆ·æ–°å—å½±å“çš„ @ConfigurationProperties é…ç½®ç±»                         |
| ğŸ’¡ è‡ªåŠ¨ç»‘å®šæ–°é…ç½®           | ä½¿ç”¨ Spring Boot åŸç”Ÿ Binder å°†æ–°å€¼ç»‘å®šåˆ°ç°æœ‰ Bean                       |
| ğŸŒ ç¯å¢ƒæ„ŸçŸ¥              | æ”¯æŒæŒ‰æ¿€æ´»çš„ profile é€‰æ‹©æ€§åˆ·æ–°                                         |
| ğŸ§© ä¸ Spring Cloud å…¼å®¹ | å¦‚æœå¼•å…¥ Spring Cloudï¼Œä¼šä¼˜å…ˆä½¿ç”¨å…¶åŸç”Ÿ @RefreshScope                     |
| ğŸ§¼ çº¿ç¨‹å®‰å…¨ + é«˜å¯ç”¨        | æ‰€æœ‰åˆ·æ–°æ“ä½œéƒ½åŸºäºçº¿ç¨‹å®‰å…¨çš„ Map å’Œ Bean å®ä¾‹å¼•ç”¨                               |

------

## **ğŸ”¨ å®ç°æ€è·¯**

### **æ ¸å¿ƒæµç¨‹ï¼š**

```
ç›‘å¬é…ç½®æ–‡ä»¶å˜æ›´
        â†“
é‡æ–°åŠ è½½å¹¶æ‰å¹³åŒ–é…ç½®
        â†“
ä¸æ—§é…ç½®è¿›è¡Œ diff æ¯”è¾ƒ
        â†“
è¯†åˆ«å—å½±å“çš„é…ç½®ç±»
        â†“
ä½¿ç”¨ Spring Binder ç»‘å®šæ–°å€¼åˆ°ç°æœ‰ Bean
```

### **æ ¸å¿ƒæ¨¡å—ï¼š**

| **æ¨¡å—ç±»**               | **ä½œç”¨**                                               |
|-----------------------|------------------------------------------------------|
| @RefreshScope         | æ ‡è®°å¯çƒ­åˆ·æ–°çš„é…ç½®ç±»ï¼ˆä¸ Spring Cloud åŒåå…¼å®¹ï¼‰                      |
| DynamicConfigLoader   | è´Ÿè´£åŠ è½½å¹¶è§£æ YAML é…ç½®ä¸ºæ‰å¹³ Map                               |
| ConfigFileWatcher     | ç›‘å¬é…ç½®ç›®å½•ä¸­æ–‡ä»¶å˜åŠ¨ï¼ˆä¿®æ”¹ã€ä¿å­˜ï¼‰                                   |
| ConfigDiffer          | æ‰§è¡Œé…ç½®å·®å¼‚å¯¹æ¯”ï¼Œè¾“å‡ºå˜æ›´å­—æ®µ                                      |
| RefreshScopeRegistry  | æ³¨å†Œæ‰€æœ‰å¸¦æœ‰ @RefreshScope + @ConfigurationProperties çš„é…ç½®ç±» |
| RefreshScopeRefresher | æŒ‰ prefix åŒ¹é…å¹¶åˆ·æ–°é…ç½®ç±»ï¼Œä½¿ç”¨ Spring Binder åŠ¨æ€ç»‘å®š              |

------

## **ğŸ“˜ ä½¿ç”¨æ–¹å¼**

### **1. æ ‡è®°é…ç½®ç±»**

```
@Configuration
@RefreshScope
@ConfigurationProperties(prefix = "custom")
public class CustomProperties {
    private String message;
    private Integer limit;

    // Getter / Setter
}
```

------

### **2. åœ¨ä¸»ç±»æˆ–é…ç½®ç±»ä¸­åˆå§‹åŒ–ç›‘å¬å™¨**

```
@Bean
public CommandLineRunner initWatcher(
        DynamicConfigLoader loader,
        RefreshScopeRegistry registry,
        RefreshScopeRefresher refresher,
        Environment env) {

    return args -> {
        AtomicReference<Map<String, Object>> current = new AtomicReference<>(loader.loadCurrentEnvironmentConfig());

        new Thread(new ConfigFileWatcher(env, changedFile -> {
            Map<String, Object> latest = loader.loadCurrentEnvironmentConfig();
            ConfigDiffer.DiffResult diff = new ConfigDiffer().diff(current.get(), latest);

            if (diff.hasDiff) {
                System.out.println("[DIFF] å˜æ›´å­—æ®µ: " + diff.changedKeys);
                current.set(latest);
                refresher.refreshByChangedKeys(diff.changedKeys);
            }
        })).start();
    };
}
```

------

### **3. è·å–é…ç½®å€¼ï¼ˆæ— éœ€ @Valueï¼‰**

```
@RestController
public class HelloController {

    private final CustomProperties props;

    public HelloController(CustomProperties props) {
        this.props = props;
    }

    @GetMapping("/hello")
    public String hello() {
        return "Message: " + props.getMessage() + ", Limit: " + props.getLimit();
    }
}
```

------

## **ğŸ§ª ç¤ºä¾‹è¡Œä¸ºè¯´æ˜**

å‡è®¾ä½ çš„é…ç½®å¦‚ä¸‹ï¼š

```
# application-prod.yml
custom:
  message: "Hello"
  limit: 10
```

è¿è¡Œç¯å¢ƒä¸º prodï¼Œå½“ä½ åœ¨éƒ¨ç½²ç›®å½•ä¸‹ä¿®æ”¹ application-prod.yml ä¸ºï¼š

```
custom:
  message: "Hi"
  limit: 20
```

å¹¶ä¿å­˜æ–‡ä»¶æ—¶ï¼š

```
[Watcher] é…ç½®æ–‡ä»¶å‘ç”Ÿå˜æ›´ï¼šapplication-prod.yml
[DIFF] å˜æ›´å­—æ®µ: [custom.message, custom.limit]
[Refresher] åˆ·æ–°é…ç½®ç±» CustomPropertiesï¼ˆå‰ç¼€ï¼šcustom.ï¼‰
```

ä½ ä¸éœ€è¦é‡å¯æœåŠ¡ï¼Œ/hello æ¥å£è¿”å›çš„é…ç½®å°±å·²æ›´æ–°ä¸ºæœ€æ–°å€¼ã€‚



------

## **ğŸ“¦ ä¸ Spring Cloud å…¼å®¹è¯´æ˜**

- @RefreshScope æ³¨è§£ä½¿ç”¨ä¸ Spring Cloud ç›¸åŒåŒ…å org.springframework.cloud.context.config.annotation
- ä½¿ç”¨ @ConditionalOnMissingClass å¯ä»¥é¿å…åœ¨ Spring Cloud å­˜åœ¨æ—¶åŠ è½½è‡ªå®šä¹‰å®ç°
- åç»­å¯å°è£…ä¸º Spring Boot Starterï¼Œè‡ªåŠ¨è¯†åˆ«æ˜¯å¦æ¥å…¥ Spring Cloud å¹¶åˆ‡æ¢å®ç°

------

## **ğŸ› ï¸ å¯é€‰æ‰©å±•å»ºè®®**

| **æ‰©å±•ç‚¹**       | **æè¿°**                       |
|---------------|------------------------------|
| â±ï¸ é…ç½®å˜æ›´äº‹ä»¶èŠ‚æµ   | å¢åŠ  debounce æœºåˆ¶ï¼Œé¿å…é¢‘ç¹åˆ·å†™        |
| ğŸ“Š å˜æ›´æ—¥å¿—æŒä¹…åŒ–    | è®°å½•æ¯æ¬¡å˜æ›´çš„æ—§å€¼ã€æ–°å€¼ã€æ—¶é—´ã€ç”¨æˆ·           |
| ğŸ”„ è‡ªå®šä¹‰åˆ·æ–°é’©å­    | æ”¯æŒé…ç½®ç±»åˆ·æ–°åå›è°ƒæ–¹æ³•ï¼Œä¾‹å¦‚ @PostRefresh |
| ğŸ“¦ å°è£… Starter | æŠ½å‡ºä¸ºå¼€æºé€šç”¨ä¾èµ–ï¼Œæ”¯æŒä¸€é”®æ¥å…¥             |

------

## **ğŸ“ é¡¹ç›®ç›®å½•ç»“æ„å»ºè®®**

```
com.example.refresh
â”œâ”€â”€ annotations
â”‚   â””â”€â”€ @RefreshScope.java
â”œâ”€â”€ core
â”‚   â”œâ”€â”€ DynamicConfigLoader.java
â”‚   â”œâ”€â”€ ConfigFileWatcher.java
â”‚   â”œâ”€â”€ ConfigDiffer.java
â”‚   â”œâ”€â”€ RefreshScopeRegistry.java
â”‚   â””â”€â”€ RefreshScopeRefresher.java
â”œâ”€â”€ autoconfig (å¯é€‰ Starter æ‰©å±•)
â”‚   â””â”€â”€ RefreshAutoConfiguration.java
â””â”€â”€ META-INF
    â””â”€â”€ spring.factories / spring.autoconfigure.imports
```

------

## **âœ… ç»“è¯­**

è¯¥ç»„ä»¶æ˜¯ä¸€ä¸ªè½»é‡çº§ã€æ— ä¾µå…¥ã€Spring åŸç”Ÿæœºåˆ¶é©±åŠ¨çš„é…ç½®çƒ­æ›´æ–°å®ç°ï¼Œé€‚åˆï¼š

- ä¸æ¥å…¥ Spring Cloud çš„æœåŠ¡
- éœ€è¦é…ç½®çµæ´»å˜æ›´ä½†åˆä¸å¸Œæœ›é‡å¯çš„åœºæ™¯
- å¯¹é…ç½®æ”¹åŠ¨æœ‰è¿½è¸ªã€å¯æ§ã€åˆ†æ¨¡å—åˆ·æ–°éœ€æ±‚çš„æ¶æ„

------


